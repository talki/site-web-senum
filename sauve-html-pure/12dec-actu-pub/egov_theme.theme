<?php

/**
 * Implements hook_preprocess_page().
 */
function egov_theme_preprocess_page(&$variables) {
  // Pour la page d'accueil uniquement
  if (\Drupal::service('path.matcher')->isFrontPage()) {
    // Charger le node 22 directement
    $node = \Drupal\node\Entity\Node::load(22);
    if ($node && $node->bundle() == 'page_d_accueil') {
      $variables['homepage_node'] = $node;
    }
    
    //  CHARGER LES ACTUALITÃ‰S POUR LA PAGE D'ACCUEIL
    $node_storage = \Drupal::entityTypeManager()->getStorage('node');
    $query = $node_storage->getQuery()
      ->condition('type', 'actualite') // Le machine name de ton content type
      ->condition('status', 1) // Seulement les contenus publiÃ©s
      ->sort('created', 'DESC') // Trier par date dÃ©croissante
      ->range(0, 10) // Limiter Ã  10 rÃ©sultats
      ->accessCheck(TRUE);
    
    $nids = $query->execute();
    $variables['actualites_recentes'] = !empty($nids) ? $node_storage->loadMultiple($nids) : [];
  }
  
  // Gestion des CSS spÃ©cifiques par page
  $node = \Drupal::routeMatch()->getParameter('node');
  
  if ($node) {
    // Page services (node 27)
    if ($node->id() == 27) {
      $variables['#attached']['library'][] = 'egov_theme/services-page';
    }
    
    // Page contact (node 28)
    if ($node->id() == 28) {
      $variables['#attached']['library'][] = 'egov_theme/contact-page';
    }
    
    //
    
    // Page tableau de bord (node 20)
    if ($node->id() == 20) {
      \Drupal::logger('egov_theme')->notice('CSS node 20 attachÃ©!');
      $variables['#attached']['library'][] = 'egov_theme/tableau-de-bord-page';
    }
    
    // Page prÃ©sentation (node 10)
    if ($node->id() == 10) {
      $variables['#attached']['library'][] = 'egov_theme/presentation-page';
    }
    
    
    // Page publications (node 31)
    if ($node->id() == 31) {
      \Drupal::logger('egov_theme')->notice('CSS publications attachÃ©!');
      $variables['#attached']['library'][] = 'egov_theme/actualites-page';

      // Charger les publications
      $node_storage = \Drupal::entityTypeManager()->getStorage('node');
      $query = $node_storage->getQuery()
        ->condition('type', 'publication')
        ->condition('status', 1)
        ->sort('created', 'DESC')
        ->range(0, 20)
        ->accessCheck(TRUE);

      $nids = $query->execute();
      $variables['publications_recentes'] = !empty($nids) ? $node_storage->loadMultiple($nids) : [];
    }

    // ğŸ†• Page actualitÃ©s (node 30) - CHARGER LES ACTUALITÃ‰S
    if ($node->id() == 30) {
      \Drupal::logger('egov_theme')->notice('CSS actualites attachÃ© okkkkkk!');
      $variables['#attached']['library'][] = 'egov_theme/actualites-page';
      
      // Charger les actualitÃ©s pour la page dÃ©diÃ©e
      $node_storage = \Drupal::entityTypeManager()->getStorage('node');
      $query = $node_storage->getQuery()
        ->condition('type', 'actualite')
        ->condition('status', 1)
        ->sort('created', 'DESC')
        ->range(0, 20) // Plus d'actualitÃ©s pour la page dÃ©diÃ©e
        ->accessCheck(TRUE);
      
      $nids = $query->execute();
      $variables['actualites_recentes'] = !empty($nids) ? $node_storage->loadMultiple($nids) : [];
    }
    
    //a deplacer dans le template mis Ã  jour depuis remoot
    if ($node->id() == 32) {
      $variables['#attached']['library'][] = 'egov_theme/actualites-detail-page';
    }
    
    if ($node->id() == 32) {
      $variables['#attached']['library'][] = 'egov_theme/publication-detail-page';
    }
    
    
    
  }
}

/**
 * Force le menu principal Ã  charger les sous-menus (multi-niveaux).
 */
function egov_theme_preprocess_block(&$variables) {
  if (isset($variables['elements']['#id']) && $variables['elements']['#id'] == 'egov_theme_main_menu') {
    $menu_tree = \Drupal::menuTree();
    $menu_name = 'main';
    
    // Charger jusqu'Ã  3 niveaux de profondeur
    $parameters = $menu_tree->getCurrentRouteMenuTreeParameters($menu_name);
    $parameters->setMinDepth(1);
    $parameters->setMaxDepth(3);
    $parameters->onlyEnabledLinks();
    
    $tree = $menu_tree->load($menu_name, $parameters);
    $manipulators = [
      ['callable' => 'menu.default_tree_manipulators:checkAccess'],
      ['callable' => 'menu.default_tree_manipulators:generateIndexAndSort'],
    ];
    $tree = $menu_tree->transform($tree, $manipulators);
    
    $variables['content'] = $menu_tree->build($tree);
  }
}