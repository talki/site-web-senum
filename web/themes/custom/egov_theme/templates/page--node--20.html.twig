{# Template pour le Tableau de Bord - Node 20 #}
{{ include(active_theme_path() ~ '/templates/partials/header.html.twig') }}

<!-- Dashboard Hero -->
<section class="dashboard-hero">
    <div class="dashboard-hero-content">
        <h1>Tableau de Bord</h1>
        <p>Vue d'ensemble des performances et des indicateurs cl√©s de la plateforme</p>

        <div class="dashboard-time">
            <div class="dashboard-time-icon">üïê</div>
            <div>
                <div class="dashboard-time-info">Derni√®re mise √† jour</div>
                <div class="dashboard-time-value" id="lastUpdate">Chargement...</div>
            </div>
        </div>
    </div>
</section>

<!-- Main Dashboard -->
<main class="dashboard-main">

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="loading-container">
        <div class="loading-spinner">‚è≥</div>
        <p>Chargement des donn√©es de monitoring...</p>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="error-container" style="display: none;">
        <div class="error-icon">‚ö†Ô∏è</div>
        <p id="errorText"></p>
        <button onclick="DashboardApp.loadData()" class="retry-btn">R√©essayer</button>
    </div>

    <!-- Stats Overview -->
    <section class="stats-overview" id="statsSection" style="display: none;">
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-card-trend up">
                    <span>‚Üë</span>
                    <span>12.5%</span>
                </div>
            </div>
            <div class="stat-card-value" id="totalTransactions">0</div>
            <div class="stat-card-label">Transactions ce mois</div>
        </div>

        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-card-trend up">
                    <span>‚Üë</span>
                    <span>8.2%</span>
                </div>
            </div>
            <div class="stat-card-value" id="totalAdministrations">0</div>
            <div class="stat-card-label">Administrations connect√©es</div>
        </div>

        <div class="stat-card">
            <div class="stat-card-header">

                <div class="stat-card-trend up">
                    <span>‚Üë</span>
                    <span>3.1%</span>
                </div>
            </div>
            <div class="stat-card-value" id="totalAPIs">0</div>
            <div class="stat-card-label">API actives</div>
        </div>


    </section>

    <!-- Dashboard Grid -->
    <section class="dashboard-grid" id="dashboardGrid" style="display: none;">
        <!-- Top Services -->
        <div class="top-services-card">
            <div class="top-services-header">
                <h2 class="top-services-title">
                    <span class="top-services-icon">

                        <img src="/themes/custom/egov_theme/icon/services_1.png" alt="" style="width: 48px; height: 48px;">

                    </span>
                    Services les plus utilis√©s
                </h2>
                <span class="top-services-period">Aujourd'hui</span>
            </div>

            <div class="top-services-list" id="topServicesList">
                <!-- Services g√©n√©r√©s dynamiquement -->
            </div>
        </div>

        <!-- Management Panel -->
        <div class="management-panel">
            <!-- Tabs Header -->
            <div class="tabs-header">
                <button class="tab-button active" data-tab="services">
                    <span class="tab-icon">
                        <img src="/themes/custom/egov_theme/icon/services_1.png" alt="" style="width: 48px; height: 48px;">


                    </span>
                    <span>Services</span>
                    <span class="tab-count" id="servicesCount">0</span>
                </button>
                <button class="tab-button" data-tab="members">
                    <span class="tab-icon">
                        <img src="/themes/custom/egov_theme/icon/agence_1.png" alt="" style="width: 48px; height: 48px;">

                    </span>
                    <span>Membres</span>
                    <span class="tab-count" id="membersCount">0</span>
                </button>
            </div>

            <!-- Services Tab -->
            <div class="tab-content active" id="services-tab">
                <!-- Filters -->
                <div class="filters-bar">
                    <div class="filter-group">
                        <button class="filter-button active" onclick="filterServices('all', event)">Tout</button>
                        <button class="filter-button" onclick="filterServices('active', event)">Actif</button>
                        <button class="filter-button" onclick="filterServices('inactive', event)">Inactif</button>
                    </div>
                    <div class="search-wrapper">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="search-input" placeholder="Rechercher un service..." onkeyup="searchServices(this.value)">
                    </div>
                </div>

                <!-- Services Table -->
                <table class="items-table" id="services-table">
                    <thead>
                        <tr>
                            <th>Service</th>
                            <th>Requ√™tes</th>
                            <th>Derni√®re activit√©</th>
                            <th>Fournisseur</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody id="servicesTableBody">
                        <!-- Lignes g√©n√©r√©es dynamiquement -->
                    </tbody>
                </table>

                <!-- Pagination -->
                <div class="pagination">
                    <div class="pagination-info" id="servicesPaginationInfo">
                        Chargement...
                    </div>
                    <div class="pagination-controls">
                        <button class="pagination-button" disabled>‚Üê Pr√©c√©dent</button>
                        <button class="pagination-button active">1</button>
                        <button class="pagination-button">Suivant ‚Üí</button>
                    </div>
                </div>
            </div>

            <!-- Members Tab -->
            <div class="tab-content" id="members-tab">
                <!-- Filters -->
                <div class="filters-bar">
                    <div class="filter-group">
                        <button class="filter-button active" onclick="filterMembers('all', event)">Tout</button>
                        <button class="filter-button" onclick="filterMembers('active', event)">Actif</button>
                        <button class="filter-button" onclick="filterMembers('inactive', event)">Inactif</button>
                    </div>
                    <div class="search-wrapper">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="search-input" placeholder="Rechercher un membre..." onkeyup="searchMembers(this.value)">
                    </div>
                </div>

                <!-- Members Table -->
                <table class="items-table" id="members-table">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Membre</th>
                            <th>Services</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody id="membersTableBody">
                        <!-- Lignes g√©n√©r√©es dynamiquement -->
                    </tbody>
                </table>

                <!-- Pagination -->
                <div class="pagination">
                    <div class="pagination-info" id="membersPaginationInfo">
                        Chargement...
                    </div>
                    <div class="pagination-controls">
                        <button class="pagination-button" disabled>‚Üê Pr√©c√©dent</button>
                        <button class="pagination-button active">1</button>
                        <button class="pagination-button">Suivant ‚Üí</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- API Usage Table -->
    <section class="api-usage-section" id="apiUsageSection" style="display: none;">
        <div class="api-usage-header">
            <h2 class="api-usage-title">Utilisation des API</h2>
        </div>

        <table class="api-table">
            <thead>
                <tr>
                    <th>API</th>
                    <th>Requ√™tes/Jour</th>
                    <th>Latence Moy.</th>
                    <th>Taux de Succ√®s</th>
                    <th>Statut</th>
                </tr>
            </thead>
            <tbody id="apiTableBody">
                <!-- Lignes g√©n√©r√©es dynamiquement -->
            </tbody>
        </table>
    </section>
</main>

{{ include(active_theme_path() ~ '/templates/partials/footer.html.twig') }}

<script>
    
    // Ajouter cette fonction en haut du script
function formatNumber(num) {
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
    } else {
        return num.toString();
    }
}

    var DashboardApp = (function () {
        'use strict';

        const API_URL = '/api/monitoring-data';
        let monitoringData = [];

        function init() {
            loadData();
            setupTabs();
            setInterval(loadData, 30000);
            updateTime();
            setInterval(updateTime, 60000);
        }

        async function loadData() {
            try {
                document.getElementById('loadingIndicator').style.display = 'block';
                document.getElementById('errorMessage').style.display = 'none';

                const res = await fetch(API_URL);

                if (!res.ok) {
                    throw new Error('Erreur HTTP: ' + res.status);
                }

                const json = await res.json();
                monitoringData = Array.isArray(json) ? json : (json.data || []);

                displayStats();
                displayTopServices();
                displayServicesTable();
                displayMembersTable();
                displayAPIUsage();

                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('statsSection').style.display = 'grid';
                document.getElementById('dashboardGrid').style.display = 'grid';
                document.getElementById('apiUsageSection').style.display = 'block';

            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorText').textContent = 'Impossible de charger les donn√©es: ' + error.message;
            }
        }

      
      
      function displayStats() {
    const totalRequests = monitoringData.length;
    document.getElementById('totalTransactions').textContent = formatNumber(totalRequests);  // ‚Üê ICI

    const allIPs = new Set();
    monitoringData.forEach(item => {
        if (item.security_server_internal_ip) allIPs.add(item.security_server_internal_ip);
        if (item.client_security_server_address) allIPs.add(item.client_security_server_address);
        if (item.service_security_server_address) allIPs.add(item.service_security_server_address);
    });
    
    document.getElementById('totalAdministrations').textContent = allIPs.size;

    const services = new Set(monitoringData.map(d => d.service_code).filter(Boolean)).size;
    document.getElementById('totalAPIs').textContent = services;
}


      
        function displayTopServices() {
            const serviceCounts = {};
            monitoringData.forEach(item => {
                const service = item.service_code || 'Unknown';
                const provider = item.service_member_code || 'Unknown';
                if (!serviceCounts[service]) {
                    serviceCounts[service] = {count: 0, provider: provider};
                }
                serviceCounts[service].count++;
            });

            const sorted = Object.entries(serviceCounts)
                    .sort((a, b) => b[1].count - a[1].count)
                    .slice(0, 5);

            const icons = ['', '', '', '', ''];

            const html = sorted.map((item, index) => {
                const [service, data] = item;
                return `
                <div class="service-item">
                    <div class="service-rank">${index + 1}</div>
                    <div class="service-info">
                        <div class="service-name">${service}</div>
                        <div class="service-member">
                            <span class="service-member-icon">${icons[index]}</span>
                            <span>${data.provider}</span>
                        </div>
                    </div>
                    <div class="service-requests">
<div class="service-requests-count">${formatNumber(data.count)}</div>  
                        <div class="service-requests-label">Requ√™tes</div>
                    </div>
                </div>
            `;
            }).join('');

            document.getElementById('topServicesList').innerHTML = html;
        }

        function displayServicesTable() {
            const serviceCounts = {};
            const now = Date.now();
            const oneDayAgo = now - (24 * 60 * 60 * 1000);

            monitoringData.forEach(item => {
                const service = item.service_code || 'Unknown';
                const provider = item.service_member_code || 'Unknown';
                const timestamp = item.request_in_ts ? item.request_in_ts * 1000 : 0;

                if (!serviceCounts[service]) {
                    serviceCounts[service] = {
                        count: 0,
                        provider: provider,
                        lastActivity: timestamp
                    };
                }
                serviceCounts[service].count++;
                if (timestamp > serviceCounts[service].lastActivity) {
                    serviceCounts[service].lastActivity = timestamp;
                }
            });

            const services = Object.entries(serviceCounts).map(([name, data]) => ({
                    name,
                    count: data.count,
                    provider: data.provider,
                    lastActivity: data.lastActivity,
                    isActive: data.lastActivity > oneDayAgo
                }));

            document.getElementById('servicesCount').textContent = services.length;

            const html = services.slice(0, 20).map(service => {
                const date = service.lastActivity ? new Date(service.lastActivity).toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                }) : 'N/A';

                return `
                <tr data-status="${service.isActive ? 'active' : 'inactive'}">
                    <td><span class="item-name">${service.name}</span></td>
                    <td><span class="item-version">${service.count}</span></td>
                    <td><span class="item-date">${date}</span></td>
                    <td><span class="item-provider">${service.provider}</span></td>
                    <td><span class="status-badge ${service.isActive ? 'active' : 'inactive'}"><span class="status-dot"></span> ${service.isActive ? 'Actif' : 'Inactif'}</span></td>
                </tr>
            `;
            }).join('');

            document.getElementById('servicesTableBody').innerHTML = html;
            document.getElementById('servicesPaginationInfo').textContent =
                    `Affichage de 1-${Math.min(20, services.length)} sur ${services.length} services`;
        }

        function displayMembersTable() {
            const memberCounts = {};
            const now = Date.now();
            const oneDayAgo = now - (24 * 60 * 60 * 1000);

            monitoringData.forEach(item => {
                const member = item.client_member_code || item.service_member_code || 'Unknown';
                const timestamp = item.request_in_ts ? item.request_in_ts * 1000 : 0;
                const service = item.service_code || 'Unknown';

                if (!memberCounts[member]) {
                    memberCounts[member] = {
                        services: new Set(),
                        lastActivity: timestamp
                    };
                }
                memberCounts[member].services.add(service);
                if (timestamp > memberCounts[member].lastActivity) {
                    memberCounts[member].lastActivity = timestamp;
                }
            });

            const members = Object.entries(memberCounts).map(([name, data]) => ({
                    name,
                    code: name.substring(0, 3).toUpperCase() + '-' + Math.floor(Math.random() * 999),
                    servicesCount: data.services.size,
                    isActive: data.lastActivity > oneDayAgo
                }));

            document.getElementById('membersCount').textContent = members.length;

            const html = members.slice(0, 20).map(member => `
            <tr data-status="${member.isActive ? 'active' : 'inactive'}">
                <td><span class="item-code">${member.code}</span></td>
                <td><span class="item-name">${member.name}</span></td>
                <td><span class="item-count">${member.servicesCount} services</span></td>
                <td><span class="status-badge ${member.isActive ? 'active' : 'inactive'}"><span class="status-dot"></span> ${member.isActive ? 'Actif' : 'Inactif'}</span></td>
            </tr>
        `).join('');

            document.getElementById('membersTableBody').innerHTML = html;
            document.getElementById('membersPaginationInfo').textContent =
                    `Affichage de 1-${Math.min(20, members.length)} sur ${members.length} membres`;
        }

    function displayAPIUsage() {
    const apiStats = {};

    monitoringData.forEach(item => {
        const service = item.service_code;
        if (!service || service === 'Unknown') return;
        
        if (!apiStats[service]) {
            apiStats[service] = {
                requests: 0,
                responses: 0,  // Nouveau : compte les r√©ponses
                successCount: 0,
                totalDuration: 0,
                validDurations: 0
            };
        }
        
        apiStats[service].requests++;
        
        // Si on a re√ßu une r√©ponse (m√™me erreur)
        if (item.response_out_ts) {
            apiStats[service].responses++;
        }
        
        // Calculer la dur√©e
        if (item.request_in_ts && item.response_out_ts) {
            const duration = item.response_out_ts - item.request_in_ts;
            if (duration > 0) {
                apiStats[service].totalDuration += duration;
                apiStats[service].validDurations++;
            }
        }
        
        // Succ√®s r√©el
        if (item.succeeded === true) {
            apiStats[service].successCount++;
        }
    });

    const sorted = Object.entries(apiStats)
        .sort((a, b) => b[1].requests - a[1].requests)
        .slice(0, 5);

    const html = sorted.map(([service, stats]) => {
        const avgLatency = stats.validDurations > 0
            ? Math.round(stats.totalDuration / stats.validDurations)
            : 0;
        
        const successRate = ((stats.successCount / stats.requests) * 100).toFixed(1);
        const responseRate = ((stats.responses / stats.requests) * 100).toFixed(1);
        
        // LOGIQUE INTELLIGENTE
        let status, statusText;
        
        if (stats.requests < 10) {
            // Peu de donn√©es
            status = 'operational';
            statusText = 'Actif';
        } else if (responseRate >= 95) {
            // Le service r√©pond (m√™me si erreurs)
            if (successRate >= 70) {
                status = 'operational';
                statusText = 'Op√©rationnel';
            } else {
                status = 'degraded';
                statusText = 'D√©grad√©';
            }
        } else if (responseRate >= 50) {
            // R√©pond partiellement
            status = 'degraded';
            statusText = 'D√©grad√©';
        } else {
            // Ne r√©pond presque pas
            status = 'down';
            statusText = 'Indisponible';
        }

        return `
        <tr>
            <td class="api-name">${service}</td>
            <td>${stats.requests.toLocaleString()}</td>
            <td>${avgLatency}ms</td>
            <td>
                <div class="progress-bar">
                    <div class="progress-bar-fill" style="width: ${successRate}%;"></div>
                </div>
                ${successRate}%
            </td>
            <td><span class="api-status ${status}">‚óè ${statusText}</span></td>
        </tr>
    `;
    }).join('');

    document.getElementById('apiTableBody').innerHTML = html;
}
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const tabName = this.getAttribute('data-tab');

                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');

                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });

                    document.getElementById(tabName + '-tab').classList.add('active');
                });
            });
        }

        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            const elem = document.getElementById('lastUpdate');
            if (elem) {
                elem.textContent = `Aujourd'hui √† ${timeString}`;
            }
        }

        return {
            init: init,
            loadData: loadData
        };
    })();

    function filterServices(status, event) {
        const buttons = document.querySelectorAll('#services-tab .filter-button');
        buttons.forEach(btn => btn.classList.remove('active'));
        if (event)
            event.currentTarget.classList.add('active');

        const rows = document.querySelectorAll('#services-table tbody tr');
        rows.forEach(row => {
            row.style.display = (status === 'all' || row.dataset.status === status) ? '' : 'none';
        });
    }

    function filterMembers(status, event) {
        const buttons = document.querySelectorAll('#members-tab .filter-button');
        buttons.forEach(btn => btn.classList.remove('active'));
        if (event)
            event.currentTarget.classList.add('active');

        const rows = document.querySelectorAll('#members-table tbody tr');
        rows.forEach(row => {
            row.style.display = (status === 'all' || row.dataset.status === status) ? '' : 'none';
        });
    }

    function searchServices(query) {
        const searchTerm = query.toLowerCase();
        const rows = document.querySelectorAll('#services-table tbody tr');
        rows.forEach(row => {
            row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
        });
    }

    function searchMembers(query) {
        const searchTerm = query.toLowerCase();
        const rows = document.querySelectorAll('#members-table tbody tr');
        rows.forEach(row => {
            row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        DashboardApp.init();
    });
</script>