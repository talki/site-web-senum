{# Template pour le Tableau de Bord - Node 20 #}

<nav>
    <div class="logo">
        <div class="logo-flag">
            <div class="flag-stripe flag-green"></div>
            <div class="flag-stripe flag-yellow"></div>
            <div class="flag-stripe flag-red"></div>
        </div>
        <div class="logo-text">
            <h1>Jokkoo</h1>
            <div class="logo-subtitle">Plateforme d'Interop√©rabilit√©</div>
        </div>
    </div>

    {# Menu Desktop #}
    <div class="nav-menu-desktop">
        {% if page.primary_menu %}
            {{ page.primary_menu }}
        {% endif %}
    </div>

    {# Actions Mobile #}
    <div class="nav-actions-mobile">
        <button class="search-btn">üîç</button>
        <button class="hamburger-btn" id="hamburgerBtn">
            <span></span>
            <span></span>
            <span></span>
        </button>
    </div>
</nav>


{# Template pour le Tableau de Bord - Node 20 #}

<!-- Dashboard Hero -->
<section class="dashboard-hero">
    <div class="dashboard-hero-content">
        <h1>Tableau de Bord Monitoring</h1>
        <p>Vue d'ensemble en temps r√©el des Security Servers</p>
        <div class="dashboard-time">
            <div class="dashboard-time-icon">üïê</div>
            <div>
                <div class="dashboard-time-info">Derni√®re mise √† jour</div>
                <div class="dashboard-time-value" id="lastUpdate">Chargement...</div>
            </div>
        </div>
    </div>
</section>

<!-- Main Dashboard -->
<main class="dashboard-main">

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="loading-container">
        <div class="loading-spinner">‚è≥</div>
        <p>Chargement des donn√©es de monitoring...</p>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="error-container" style="display: none;">
        <div class="error-icon">‚ö†Ô∏è</div>
        <p id="errorText"></p>
        <button onclick="loadMonitoringData()" class="retry-btn">R√©essayer</button>
    </div>

    <!-- Stats Overview (Global) -->
    <section class="stats-overview" id="globalStats" style="display: none;">
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-card-icon">üñ•Ô∏è</div>
            </div>
            <div class="stat-card-value" id="totalServers">0</div>
            <div class="stat-card-label">Security Servers</div>
        </div>

        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-card-icon">üìä</div>
            </div>
            <div class="stat-card-value" id="totalRequests">0</div>
            <div class="stat-card-label">Requ√™tes totales</div>
        </div>

        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-card-icon">‚úÖ</div>
            </div>
            <div class="stat-card-value" id="avgSuccessRate">0%</div>
            <div class="stat-card-label">Taux de succ√®s moyen</div>
        </div>

        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-card-icon">‚ö°</div>
            </div>
            <div class="stat-card-value" id="activeServers">0</div>
            <div class="stat-card-label">Serveurs actifs</div>
        </div>
    </section>

    <!-- Security Servers Tabs -->
    <section class="ss-tabs-section" id="ssTabsSection" style="display: none;">
        <div class="ss-tabs-header">
            <h2>Security Servers</h2>
        </div>

        <div class="ss-tabs" id="ssTabs">
            <!-- Onglets g√©n√©r√©s dynamiquement -->
        </div>

        <div class="ss-tab-content" id="ssTabContent">
            <!-- Contenu de l'onglet actif -->
        </div>
    </section>

</main>

<script>
    (function () {
        'use strict';

        // Configuration
        const MONITORING_API_URL = '/api/monitoring-data';

        // Mapping des IPs vers les noms d'organisations
        const SS_NAMES = {
            '10.0.1.62': 'SECURITE-CENTRAL',
            '10.0.1.198': 'DONNEES-REF',
            '10.0.3.98': 'DGD',
            '10.0.2.173': 'GDID',
            '10.0.2.189': 'DGPSN',
            '10.0.3.48': 'SEN-CSU'
        };

        // Variables globales
        let monitoringData = [];
        let securityServers = {};
        let currentTab = null;

        // Fonction pour obtenir le nom d'un Security Server
        function getServerName(ip) {
            return SS_NAMES[ip] || ip;
        }

        // Charger les donn√©es au chargement de la page
        document.addEventListener('DOMContentLoaded', function () {
            loadMonitoringData();

            // Actualiser toutes les 30 secondes
            setInterval(loadMonitoringData, 30000);
        });

        // Fonction pour charger les donn√©es
        window.loadMonitoringData = async function () {
            try {
                document.getElementById('loadingIndicator').style.display = 'block';
                document.getElementById('errorMessage').style.display = 'none';

                const response = await fetch(MONITORING_API_URL);

                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }

                const data = await response.json();
                monitoringData = Array.isArray(data) ? data : [];

                // Organiser les donn√©es par Security Server
                organizeDataBySecurityServer();

                // Afficher les donn√©es
                displayGlobalStats();
                displaySecurityServerTabs();

                // Masquer le loading
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('globalStats').style.display = 'grid';
                document.getElementById('ssTabsSection').style.display = 'block';

                // Mettre √† jour l'heure
                updateLastUpdateTime();

            } catch (error) {
                console.error('Erreur lors du chargement des donn√©es:', error);
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorText').textContent = `Impossible de charger les donn√©es: ${error.message}`;
            }
        }

        // Organiser les donn√©es par Security Server
        function organizeDataBySecurityServer() {
            securityServers = {};

            monitoringData.forEach(item => {
                const ssIp = item.security_server_internal_ip;

                if (!securityServers[ssIp]) {
                    securityServers[ssIp] = [];
                }

                securityServers[ssIp].push(item);
            });
        }

        // Afficher les statistiques globales
        function displayGlobalStats() {
            const totalServers = Object.keys(securityServers).length;
            document.getElementById('totalServers').textContent = totalServers;

            const totalRequests = monitoringData.length;
            document.getElementById('totalRequests').textContent = totalRequests.toLocaleString();

            // Calculer le taux de succ√®s moyen
            let successCount = 0;
            monitoringData.forEach(item => {
                if (item.succeeded !== false) {
                    successCount++;
                }
            });
            const successRate = totalRequests > 0 ? ((successCount / totalRequests) * 100).toFixed(1) : 0;
            document.getElementById('avgSuccessRate').textContent = successRate + '%';

            document.getElementById('activeServers').textContent = totalServers;
        }

        // Afficher les onglets des Security Servers
        function displaySecurityServerTabs() {
            const tabsContainer = document.getElementById('ssTabs');
            tabsContainer.innerHTML = '';

            let isFirst = true;

            // Trier par nom pour un affichage coh√©rent
            const sortedServers = Object.keys(securityServers).sort((a, b) => {
                return getServerName(a).localeCompare(getServerName(b));
            });

            sortedServers.forEach(ssIp => {
                const tab = document.createElement('button');
                tab.className = 'ss-tab' + (isFirst ? ' active' : '');
                tab.dataset.ip = ssIp;

                const serverName = getServerName(ssIp);
                const nameSpan = document.createElement('span');
                nameSpan.textContent = serverName;
                tab.appendChild(nameSpan);

                const count = securityServers[ssIp].length;
                const badge = document.createElement('span');
                badge.className = 'ss-tab-badge';
                badge.textContent = count;
                tab.appendChild(badge);

                tab.addEventListener('click', function () {
                    switchTab(ssIp);
                });

                tabsContainer.appendChild(tab);

                if (isFirst) {
                    displayServerData(ssIp);
                    currentTab = ssIp;
                    isFirst = false;
                }
            });
        }

        // Changer d'onglet
        function switchTab(ssIp) {
            // Mettre √† jour les onglets actifs
            document.querySelectorAll('.ss-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.ip === ssIp) {
                    tab.classList.add('active');
                }
            });

            currentTab = ssIp;

            // Afficher les donn√©es du serveur
            displayServerData(ssIp);
        }

        // Afficher les donn√©es d'un Security Server
        function displayServerData(ssIp) {
            const contentContainer = document.getElementById('ssTabContent');
            const serverData = securityServers[ssIp];

            if (!serverData || serverData.length === 0) {
                contentContainer.innerHTML = '<p>Aucune donn√©e disponible pour ce serveur.</p>';
                return;
            }

            const serverName = getServerName(ssIp);

            // Cr√©er le contenu HTML
            let html = `
            <div class="ss-detail-header">
                <div>
                    <h3>${serverName}</h3>
                    <div class="ss-ip-info">IP Interne: ${ssIp}</div>
                </div>
                <div class="ss-stats-mini">
                    <span class="ss-stat">üìä ${serverData.length} enregistrements</span>
                </div>
            </div>
            
            <div class="ss-data-table">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Service</th>
                            <th>Client</th>
                            <th>Provider</th>
                            <th>Timestamp</th>
                            <th>Dur√©e (ms)</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

            // Afficher les 50 premi√®res entr√©es
            serverData.slice(0, 50).forEach(item => {
                const timestamp = item.request_in_ts ? new Date(item.request_in_ts * 1000).toLocaleString('fr-FR') : 'N/A';
                const duration = item.total_duration ? item.total_duration + ' ms' : 'N/A';
                const succeeded = item.succeeded !== false;

                html += `
                <tr>
                    <td><strong>${item.service_code || 'N/A'}</strong></td>
                    <td>${item.client_member_code || 'N/A'}</td>
                    <td>${item.service_member_code || 'N/A'}</td>
                    <td>${timestamp}</td>
                    <td>${duration}</td>
                    <td>
                        <span class="status-badge ${succeeded ? 'success' : 'error'}">
                            ${succeeded ? '‚úì Succ√®s' : '‚úó Erreur'}
                        </span>
                    </td>
                </tr>
            `;
            });

            html += `
                    </tbody>
                </table>
            </div>
        `;

            contentContainer.innerHTML = html;
        }

        // Mettre √† jour l'heure de derni√®re mise √† jour
        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('lastUpdate').textContent = `Aujourd'hui √† ${timeString}`;
        }

    })();
</script>