{# Template pour le Tableau de Bord - Node 20 #}

<!-- Dashboard Hero -->
<section class="dashboard-hero">
    <div class="dashboard-hero-content">
        <h1>Tableau de Bord Monitoring</h1>
        <p>Vue d'ensemble en temps r√©el des Security Servers</p>
        <div class="dashboard-time">
            <div class="dashboard-time-icon">üïê</div>
            <div>
                <div class="dashboard-time-info">Derni√®re mise √† jour</div>
                <div class="dashboard-time-value" id="lastUpdate">Chargement...</div>
            </div>
        </div>
    </div>
</section>

<!-- Main Dashboard -->
<main class="dashboard-main">
    
    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="loading-container">
        <div class="loading-spinner">‚è≥</div>
        <p>Chargement des donn√©es de monitoring...</p>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="error-container" style="display: none;">
        <div class="error-icon">‚ö†Ô∏è</div>
        <p id="errorText"></p>
        <button onclick="loadMonitoringData()" class="retry-btn">R√©essayer</button>
    </div>

    <!-- Stats Overview (Global) -->
    <section class="stats-overview" id="globalStats" style="display: none;">
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-card-icon">üñ•Ô∏è</div>
            </div>
            <div class="stat-card-value" id="totalServers">0</div>
            <div class="stat-card-label">Security Servers</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-card-icon">üìä</div>
            </div>
            <div class="stat-card-value" id="totalRequests">0</div>
            <div class="stat-card-label">Requ√™tes totales</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-card-icon">‚úÖ</div>
            </div>
            <div class="stat-card-value" id="avgSuccessRate">0%</div>
            <div class="stat-card-label">Taux de succ√®s moyen</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-card-icon">‚ö°</div>
            </div>
            <div class="stat-card-value" id="activeServers">0</div>
            <div class="stat-card-label">Serveurs actifs</div>
        </div>
    </section>

    <!-- Security Servers Tabs -->
    <section class="ss-tabs-section" id="ssTabsSection" style="display: none;">
        <div class="ss-tabs-header">
            <h2>Security Servers</h2>
        </div>
        
        <div class="ss-tabs" id="ssTabs">
            <!-- Onglets g√©n√©r√©s dynamiquement -->
        </div>
        
        <div class="ss-tab-content" id="ssTabContent">
            <!-- Contenu de l'onglet actif -->
        </div>
    </section>

</main>

<script>
// URL de l'API de monitoring
const MONITORING_API_URL = 'http://102.164.134.109/operational_data';

// Variable globale pour stocker les donn√©es
let monitoringData = [];
let securityServers = {};

// Charger les donn√©es au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    loadMonitoringData();
    
    // Actualiser toutes les 30 secondes
    setInterval(loadMonitoringData, 30000);
});

// Fonction pour charger les donn√©es
async function loadMonitoringData() {
    try {
        document.getElementById('loadingIndicator').style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';
        
        const response = await fetch(MONITORING_API_URL);
        
        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        monitoringData = data;
        
        // Organiser les donn√©es par Security Server
        organizeDataBySecurityServer();
        
        // Afficher les donn√©es
        displayGlobalStats();
        displaySecurityServerTabs();
        
        // Masquer le loading
        document.getElementById('loadingIndicator').style.display = 'none';
        document.getElementById('globalStats').style.display = 'grid';
        document.getElementById('ssTabsSection').style.display = 'block';
        
        // Mettre √† jour l'heure
        updateLastUpdateTime();
        
    } catch (error) {
        console.error('Erreur lors du chargement des donn√©es:', error);
        document.getElementById('loadingIndicator').style.display = 'none';
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('errorText').textContent = `Impossible de charger les donn√©es: ${error.message}`;
    }
}

// Organiser les donn√©es par Security Server
function organizeDataBySecurityServer() {
    securityServers = {};
    
    monitoringData.forEach(item => {
        const ssIp = item.security_server_internal_ip;
        
        if (!securityServers[ssIp]) {
            securityServers[ssIp] = [];
        }
        
        securityServers[ssIp].push(item);
    });
}

// Afficher les statistiques globales
function displayGlobalStats() {
    const totalServers = Object.keys(securityServers).length;
    document.getElementById('totalServers').textContent = totalServers;
    
    const totalRequests = monitoringData.length;
    document.getElementById('totalRequests').textContent = totalRequests.toLocaleString();
    
    // Calculer le taux de succ√®s moyen (si disponible dans les donn√©es)
    // √Ä adapter selon la structure r√©elle de l'API
    document.getElementById('avgSuccessRate').textContent = '99.2%';
    
    document.getElementById('activeServers').textContent = totalServers;
}

// Afficher les onglets des Security Servers
function displaySecurityServerTabs() {
    const tabsContainer = document.getElementById('ssTabs');
    tabsContainer.innerHTML = '';
    
    let isFirst = true;
    
    Object.keys(securityServers).forEach(ssIp => {
        const tab = document.createElement('button');
        tab.className = 'ss-tab' + (isFirst ? ' active' : '');
        tab.textContent = `SS ${ssIp}`;
        tab.onclick = () => switchTab(ssIp);
        
        const count = securityServers[ssIp].length;
        const badge = document.createElement('span');
        badge.className = 'ss-tab-badge';
        badge.textContent = count;
        tab.appendChild(badge);
        
        tabsContainer.appendChild(tab);
        
        if (isFirst) {
            displayServerData(ssIp);
            isFirst = false;
        }
    });
}

// Changer d'onglet
function switchTab(ssIp) {
    // Mettre √† jour les onglets actifs
    document.querySelectorAll('.ss-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.closest('.ss-tab').classList.add('active');
    
    // Afficher les donn√©es du serveur
    displayServerData(ssIp);
}

// Afficher les donn√©es d'un Security Server
function displayServerData(ssIp) {
    const contentContainer = document.getElementById('ssTabContent');
    const serverData = securityServers[ssIp];
    
    if (!serverData || serverData.length === 0) {
        contentContainer.innerHTML = '<p>Aucune donn√©e disponible pour ce serveur.</p>';
        return;
    }
    
    // Cr√©er le contenu HTML
    let html = `
        <div class="ss-detail-header">
            <h3>Security Server: ${ssIp}</h3>
            <div class="ss-stats-mini">
                <span class="ss-stat">üìä ${serverData.length} enregistrements</span>
            </div>
        </div>
        
        <div class="ss-data-table">
            <table class="table">
                <thead>
                    <tr>
                        <th>Service</th>
                        <th>Client</th>
                        <th>Timestamp</th>
                        <th>Statut</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Afficher les 20 premi√®res entr√©es
    serverData.slice(0, 20).forEach(item => {
        html += `
            <tr>
                <td>${item.service_code || 'N/A'}</td>
                <td>${item.client_member_code || 'N/A'}</td>
                <td>${new Date(item.request_in_ts * 1000).toLocaleString('fr-FR')}</td>
                <td><span class="status-badge success">‚úì</span></td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    contentContainer.innerHTML = html;
}

// Mettre √† jour l'heure de derni√®re mise √† jour
function updateLastUpdateTime() {
    const now = new Date();
    const timeString = now.toLocaleString('fr-FR', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    document.getElementById('lastUpdate').textContent = `Aujourd'hui √† ${timeString}`;
}
</script>