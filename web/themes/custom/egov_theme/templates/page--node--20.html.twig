{# Template pour le Tableau de Bord - Node 20 #}

<nav>
    <div class="logo">
        <div class="logo-flag">
            <div class="flag-stripe flag-green"></div>
            <div class="flag-stripe flag-yellow"></div>
            <div class="flag-stripe flag-red"></div>
        </div>
        <div class="logo-text">
            <h1>Jokkoo</h1>
            <div class="logo-subtitle">Plateforme d'Interop√©rabilit√©</div>
        </div>
    </div>

    {# Menu Desktop #}
    <div class="nav-menu-desktop">
        {% if page.primary_menu %}
            {{ page.primary_menu }}
        {% endif %}
    </div>

    {# Actions Mobile #}
    <div class="nav-actions-mobile">
        <button class="search-btn">üîç</button>
        <button class="hamburger-btn" id="hamburgerBtn">
            <span></span>
            <span></span>
            <span></span>
        </button>
    </div>
</nav>

{# Template pour le Tableau de Bord - Node 20 #}

<!-- Dashboard Hero -->
<section class="dashboard-hero">
    <div class="dashboard-hero-content">
        <h1>Tableau de Bord Monitoring</h1>
        <p>Vue d'ensemble en temps r√©el des Security Servers</p>
        <div class="dashboard-time">
            <div class="dashboard-time-icon">üïê</div>
            <div>
                <div class="dashboard-time-info">Derni√®re mise √† jour</div>
                <div class="dashboard-time-value" id="lastUpdate">Chargement...</div>
            </div>
        </div>
    </div>
</section>

<!-- Environment Filter -->
<section class="environment-filter">
    <div class="filter-label"></div>
    <div class="filter-options">
        <label class="filter-radio">
            <input type="radio" name="environment" value="prod" checked>
            <span class="filter-radio-label">
                <span class="filter-icon">üü¢</span>
                Production
            </span>
        </label>
        <label class="filter-radio">
            <input type="radio" name="environment" value="uat">
            <span class="filter-radio-label">
                <span class="filter-icon">üü°</span>
                UAT
            </span>
        </label>
        <label class="filter-radio">
            <input type="radio" name="environment" value="integration">
            <span class="filter-radio-label">
                <span class="filter-icon">üîµ</span>
                Int√©gration
            </span>
        </label>
    </div>
</section>

<!-- Main Dashboard -->
<main class="dashboard-main">
    
    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="loading-container">
        <div class="loading-spinner">‚è≥</div>
        <p>Chargement des donn√©es de monitoring...</p>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="error-container" style="display: none;">
        <div class="error-icon">‚ö†Ô∏è</div>
        <p id="errorText"></p>
        <button onclick="MonitoringDashboard.loadData()" class="retry-btn">R√©essayer</button>
    </div>

    <!-- Stats Overview (Global) -->
    <section class="stats-overview" id="globalStats" style="display: none;">
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-card-icon">üñ•Ô∏è</div>
            </div>
            <div class="stat-card-value" id="totalServers">0</div>
            <div class="stat-card-label">Security Servers</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-card-icon">üìä</div>
            </div>
            <div class="stat-card-value" id="totalRequests">0</div>
            <div class="stat-card-label">Requ√™tes totales</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-card-icon">‚úÖ</div>
            </div>
            <div class="stat-card-value" id="avgSuccessRate">0%</div>
            <div class="stat-card-label">Taux de succ√®s moyen</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-card-icon">‚ö°</div>
            </div>
            <div class="stat-card-value" id="activeServers">0</div>
            <div class="stat-card-label">Serveurs actifs</div>
        </div>
    </section>

    <!-- Security Servers Tabs -->
    <section class="ss-tabs-section" id="ssTabsSection" style="display: none;">
        <div class="ss-tabs-header">
            <h2>Security Servers</h2>
        </div>
        
        <div class="ss-tabs" id="ssTabs">
            <!-- Onglets g√©n√©r√©s dynamiquement -->
        </div>
        
        <div class="ss-tab-content" id="ssTabContent">
            <!-- Contenu de l'onglet actif -->
        </div>
    </section>

</main>
  <!-- Footer -->
    <footer>
        <div class="footer-grid">
            <div class="footer-section footer-about">
                <h3>√Ä PROPOS</h3>
                <p>
                    La Plateforme Nationale d'Interop√©rabilit√© du S√©n√©gal (eGov S√©n√©gal) 
                    est une initiative du Minist√®re de la Communication, des T√©l√©communications 
                    et du Num√©rique dans le cadre du New Deal Technologique.
                </p>
                <div class="social-icons">
                    <div class="social-icon">üìò</div>
                    <div class="social-icon">üê¶</div>
                    <div class="social-icon">üíº</div>
                    <div class="social-icon">üì∏</div>
                    <div class="social-icon">üìπ</div>
                </div>
            </div>

            <div class="footer-section">
                <h3>SERVICES</h3>
                <ul>
                    <li><a href="#protection-sociale">Protection Sociale</a></li>
                    <li><a href="#troisieme-age">Troisi√®me √Çge</a></li>
                    <li><a href="#education">√âducation</a></li>
                    <li><a href="#citoyennete">Citoyennet√©</a></li>
                    <li><a href="#taxes">Taxes & Imp√¥ts</a></li>
                    <li><a href="#sante">Sant√©</a></li>
                </ul>
            </div>

            <div class="footer-section">
                <h3>RESSOURCES</h3>
                <ul>
                    <li><a href="#">Documentation API</a></li>
                    <li><a href="#">Guides d'Int√©gration</a></li>
                    <li><a href="#">Catalogue d'API</a></li>
                    <li><a href="#">Centre d'Aide</a></li>
                    <li><a href="#">FAQ</a></li>
                    <li><a href="#">Blog</a></li>
                </ul>
            </div>

            <div class="footer-section">
                <h3>CONTACT</h3>
                <ul>
                    <li><a href="#">üìç Dakar, S√©n√©gal</a></li>
                    <li><a href="#">üìß contact@egov.sn</a></li>
                    <li><a href="#">üìû +221 33 XXX XX XX</a></li>
                    <li><a href="#">üí¨ Chat en Direct</a></li>
                    <li><a href="#">üé´ Cr√©er un Ticket</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <p>¬© 2025 eGov S√©n√©gal - MCTN/SENUM - R√©publique du S√©n√©gal</p>
            <div class="footer-bottom-links">
                <a href="#">Mentions L√©gales</a>
                <a href="#">Politique de Confidentialit√©</a>
                <a href="#">Conditions d'Utilisation</a>
                <a href="#">Accessibilit√©</a>
                <a href="#">Plan du Site</a>
            </div>
        </div>
    </footer>
<script>
var MonitoringDashboard = (function() {
    'use strict';
    
    // Configuration
    const API_URL = '/api/monitoring-data';
    
    // Mapping des IPs vers les noms d'organisations
    const SS_NAMES = {
        // PROD
        '10.0.1.62': 'SECURITE-CENTRAL',
        '10.0.1.198': 'DONNEES-REF',
        '10.0.3.98': 'DGD',
        '10.0.2.173': 'GDID',
        '10.0.2.189': 'DGPSN',
        '10.0.3.48': 'SEN-CSU',
        // INTEGRATION
        '10.121.222.37': 'INT-SECURITE-CENTRAL',
        '10.121.222.38': 'INT-DONNEES-REF',
        '10.121.222.39': 'INT-DGD',
        '10.121.222.40': 'INT-DGID',
        '10.121.222.41': 'INT-DGPSN',
        '10.121.222.42': 'INT-SEN-CSU'
    };
    
    // Variables
    let monitoringData = [];
    let securityServers = {};
    let currentEnvironment = 'all';
    let currentTab = null;
    
    // Fonction pour obtenir le nom d'un Security Server
    function getServerName(ip) {
        return SS_NAMES[ip] || ip;
    }
    
    // Initialisation
    function init() {
        loadData();
        
        // Event listener pour les filtres d'environnement
        document.querySelectorAll('input[name="environment"]').forEach(function(radio) {
            radio.addEventListener('change', function() {
                currentEnvironment = this.value;
                filterByEnvironment();
            });
        });
        
        // Actualiser toutes les 30 secondes
        setInterval(loadData, 30000);
    }
    
    // Fonction pour charger les donn√©es
    async function loadData() {
        try {
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            
            const url = API_URL;
            const res = await fetch(url);
            
            if (!res.ok) {
                throw new Error('Erreur HTTP: ' + res.status);
            }
            
            const json = await res.json();
            
            // G√©rer le nouveau format avec wrapper
            if (json.data && Array.isArray(json.data)) {
                monitoringData = json.data;
            } else if (Array.isArray(json)) {
                monitoringData = json;
            } else {
                monitoringData = [];
            }
            
            filterByEnvironment();
            
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('globalStats').style.display = 'grid';
            document.getElementById('ssTabsSection').style.display = 'block';
            
            updateLastUpdateTime();
            
        } catch (error) {
            console.error('Erreur:', error);
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorText').textContent = 'Impossible de charger les donn√©es: ' + error.message;
        }
    }
    
    // Filtrer les donn√©es par environnement
    function filterByEnvironment() {
        let filteredData = monitoringData;
        
        if (currentEnvironment !== 'all') {
            filteredData = monitoringData.filter(function(item) {
                return (item.environment || 'PROD') === currentEnvironment.toUpperCase();
            });
        }
        
        // R√©organiser avec les donn√©es filtr√©es
        securityServers = {};
        filteredData.forEach(function(item) {
            const ssIp = item.security_server_internal_ip;
            if (!securityServers[ssIp]) {
                securityServers[ssIp] = [];
            }
            securityServers[ssIp].push(item);
        });
        
        // Mettre √† jour l'affichage
        displayGlobalStats();
        displaySecurityServerTabs();
    }
    
    function displayGlobalStats() {
        const totalServers = Object.keys(securityServers).length;
        document.getElementById('totalServers').textContent = totalServers;
        
        // Compter depuis securityServers (donn√©es filtr√©es)
        let totalRequests = 0;
        Object.values(securityServers).forEach(function(items) {
            totalRequests += items.length;
        });
        document.getElementById('totalRequests').textContent = totalRequests.toLocaleString();
        
        let successCount = 0;
        Object.values(securityServers).forEach(function(items) {
            items.forEach(function(item) {
                if (item.succeeded !== false) {
                    successCount++;
                }
            });
        });
        const successRate = totalRequests > 0 ? ((successCount / totalRequests) * 100).toFixed(1) : 0;
        document.getElementById('avgSuccessRate').textContent = successRate + '%';
        
        document.getElementById('activeServers').textContent = totalServers;
    }
    
    function displaySecurityServerTabs() {
        const tabsContainer = document.getElementById('ssTabs');
        tabsContainer.innerHTML = '';
        
        let isFirst = true;
        
        const sortedServers = Object.keys(securityServers).sort(function(a, b) {
            return getServerName(a).localeCompare(getServerName(b));
        });
        
        sortedServers.forEach(function(ssIp) {
            const tab = document.createElement('button');
            tab.className = 'ss-tab' + (isFirst ? ' active' : '');
            tab.dataset.ip = ssIp;
            
            const serverName = getServerName(ssIp);
            const nameSpan = document.createElement('span');
            nameSpan.textContent = serverName;
            tab.appendChild(nameSpan);
            
            const count = securityServers[ssIp].length;
            const badge = document.createElement('span');
            badge.className = 'ss-tab-badge';
            badge.textContent = count;
            tab.appendChild(badge);
            
            tab.addEventListener('click', function() {
                switchTab(ssIp);
            });
            
            tabsContainer.appendChild(tab);
            
            if (isFirst) {
                displayServerData(ssIp);
                currentTab = ssIp;
                isFirst = false;
            }
        });
    }
    
    function switchTab(ssIp) {
        document.querySelectorAll('.ss-tab').forEach(function(tab) {
            tab.classList.remove('active');
            if (tab.dataset.ip === ssIp) {
                tab.classList.add('active');
            }
        });
        
        currentTab = ssIp;
        displayServerData(ssIp);
    }
    
    function displayServerData(ssIp) {
        const contentContainer = document.getElementById('ssTabContent');
        const serverData = securityServers[ssIp];
        
        if (!serverData || serverData.length === 0) {
            contentContainer.innerHTML = '<p>Aucune donn√©e disponible pour ce serveur.</p>';
            return;
        }
        
        const serverName = getServerName(ssIp);
        
        let html = '<div class="ss-detail-header"><div><h3>' + serverName + '</h3>';
        html += '<div class="ss-ip-info">IP Interne: ' + ssIp + '</div></div>';
        html += '<div class="ss-stats-mini"><span class="ss-stat">üìä ' + serverData.length + ' enregistrements</span></div></div>';
        html += '<div class="ss-data-table"><table class="table"><thead><tr>';
        html += '<th>Env</th><th>Service</th><th>Client</th><th>Provider</th><th>Timestamp</th><th>Dur√©e (ms)</th><th>Statut</th>';
        html += '</tr></thead><tbody>';
        
        serverData.slice(0, 50).forEach(function(item) {
            const timestamp = item.request_in_ts ? new Date(item.request_in_ts * 1000).toLocaleString('fr-FR') : 'N/A';
            const duration = item.total_duration ? item.total_duration + ' ms' : 'N/A';
            const succeeded = item.succeeded !== false;
            const env = item.environment || 'PROD';
            
            html += '<tr>';
            html += '<td><span class="env-badge ' + env.toLowerCase() + '">' + env + '</span></td>';
            html += '<td><strong>' + (item.service_code || 'N/A') + '</strong></td>';
            html += '<td>' + (item.client_member_code || 'N/A') + '</td>';
            html += '<td>' + (item.service_member_code || 'N/A') + '</td>';
            html += '<td>' + timestamp + '</td>';
            html += '<td>' + duration + '</td>';
            html += '<td><span class="status-badge ' + (succeeded ? 'success' : 'error') + '">';
            html += succeeded ? '‚úì Succ√®s' : '‚úó Erreur';
            html += '</span></td></tr>';
        });
        
        html += '</tbody></table></div>';
        contentContainer.innerHTML = html;
    }
    
    function updateLastUpdateTime() {
        const now = new Date();
        const timeString = now.toLocaleString('fr-FR', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        document.getElementById('lastUpdate').textContent = 'Aujourd\'hui √† ' + timeString;
    }
    
    // Public API
    return {
        init: init,
        loadData: loadData
    };
    
})();

// Init au chargement
document.addEventListener('DOMContentLoaded', function() {
    MonitoringDashboard.init();
});
</script>